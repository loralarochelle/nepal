---
title: "Basic Plots"
format: html
editor: visual
---

```{r loading files}
library(tidyverse)
library(dplyr)
nepal <- read.csv("nepal.csv")
nepal_gps <- read.csv("nepal_gps.csv")
pcv10_serotypes <- c('1', '4', '5', '6B', '7F', '9V', '14', '18C', '19F', '23F') 
pcv13_serotypes <- c('3', '6A', '19A')
pcv15_serotypes <- c('22F', '33F')
pcv20_serotypes <- c('8', '10A', '11A', '12F', '15B')
```

Introductory work:

```{r plotting trends of serotypes}
# getting data ready for plotting
nepal_plot_data <- nepal %>%
  # select serotype + year columns
  dplyr::select(Serotype, X2014n, X2015n, X2017n, X2018n, X2019n, X2021n) %>%
  # format data frame
  pivot_longer(cols = -Serotype,
               names_to = "Year",
               values_to = "Count") %>%
  # remove X and n from the year counts
  mutate(Year = gsub("X|n", "", Year)) %>%
  # filter out pcv10serotypes & the total rows
  filter((!Serotype %in% pcv10serotypes) & (!Serotype=="Total"))

# plot serotype trends over time
ggplot(data = nepal_plot_data, aes(x = as.numeric(Year), y = Count, color = Serotype)) +
  geom_line() +
  theme_bw() +
  labs(x = "Year", y = "Count", title = "Pneumococcal Infection Counts")
```

```{r plotting trends of PCV serotypes}
# getting data ready for plotting
nepal_plot_data_PCV10 <- nepal %>%
  # select serotype + year columns
  dplyr::select(Serotype, X2014n, X2015n, X2017n, X2018n, X2019n, X2021n) %>%
  # format data frame
  pivot_longer(cols = -Serotype,
               names_to = "Year",
               values_to = "Count") %>%
  # remove X and n from the year counts
  mutate(Year = gsub("X|n", "", Year)) %>%
  # filter out pcv10serotypes & the total rows
  filter((Serotype %in% pcv10serotypes) & (!Serotype=="Total"))

# plot serotype trends over time
ggplot(data = nepal_plot_data_PCV10, aes(x = as.numeric(Year), y = Count, color = Serotype)) +
  geom_line() +
  theme_bw() +
  labs(x = "Year", y = "Count", title = "PCV10 Pneumococcal Infections")
```

```{r same code as above, but with proportions instead of counts}
# getting data ready for plotting
nepal_plot_data_prop <- nepal %>%
  # select serotype + year columns
  dplyr::select(Serotype, X2014p, X2015p, X2017p, X2018p, X2019p, X2021p) %>%
  # format data frame
  pivot_longer(cols = -Serotype,
               names_to = "Year",
               values_to = "Proportion") %>%
  # remove X and n from the years
  mutate(Year = gsub("X|p", "", Year)) %>%
  # filter out pcv10serotypes & the total rows
  filter((!Serotype %in% pcv10serotypes) & (!Serotype=="Total"))

nepal_plot_data_prop

# plot serotype trends over time
ggplot(data = nepal_plot_data_prop, aes(x = as.numeric(Year), y = Proportion, color = Serotype)) +
  geom_line() +
  theme_bw() +
  labs(x = "Year", y = "Proportion", title = "Pneumococcal Infection \nProportions by Serotype Over Time")

```

```{r}
serotypes_all <- unique(nepal_gps$In_silico_serotype)
non_vaccine_serotypes <- setdiff(serotypes_all, pcv10_serotypes)
non_vaccine_serotypes <- non_vaccine_serotypes[!non_vaccine_serotypes %in% c("ALTERNATIVE_ALIB_NT","COVERAGE TOO LOW", "SWISS_NT", "UNTYPABLE")]
                                                 
# Shorten and classify
nepal_shortened <- nepal_gps[, c("Year", "Clinical_manifestation", "In_silico_serotype")]

nepal_shortened$Serotype_group <- ifelse(
  nepal_shortened$In_silico_serotype %in% pcv10_serotypes, "PCV10",
  ifelse(nepal_shortened$In_silico_serotype %in% pcv13_serotypes, "PCV13",
  ifelse(nepal_shortened$In_silico_serotype %in% pcv15_serotypes, "PCV15",
  ifelse(nepal_shortened$In_silico_serotype %in% pcv20_serotypes, "PCV20", "Other"))))

# Assign Disease vs Carriage
nepal_shortened <- nepal_shortened %>%
  filter(Year >= 2009) %>%
  mutate(Disease_Status = ifelse(Clinical_manifestation == "CARRIAGE", "Carriage", "Disease"))

# Count data
nepal_serotype_counts <- nepal_shortened %>%
  group_by(Year, Disease_Status, Serotype_group) %>%
  summarise(count = n(), .groups = "drop")

# Proportion data (within each year and disease status)
nepal_serotype_props <- nepal_serotype_counts %>%
  group_by(Year, Disease_Status) %>%
  mutate(prop = count / sum(count)) %>%
  ungroup()

# Define custom color palette
custom_colors <- c(
  "PCV10" = "#00356B",   # Yale Blue
  "PCV13" = "#6A0DAD",   # Purple
  "PCV15" = "#008080",   # Teal
  "PCV20" = "#E69F00",   # Gold
  "Other" = "#999999"    # Grey fallback
)

# === Original count plot ===
ggplot(nepal_serotype_counts, aes(x = Year, y = count, color = Serotype_group)) +
  geom_line() +
  geom_point() +
  facet_grid(Disease_Status ~ .) +
  scale_color_manual(values = custom_colors) +
  labs(
    title = "Pneumococcal Disease Prevalence in Nepal\nby Serotype Group Over Time",
    y = "Case Count",
    x = "Year",
    color = "Serotype Group"
  ) +
  theme_bw() +
  theme(plot.title = element_text(face = "bold", size = 14))

# === New proportion plot ===
ggplot(nepal_serotype_props, aes(x = Year, y = prop, color = Serotype_group)) +
  geom_line() +
  geom_point() +
  facet_grid(Disease_Status ~ .) +
  scale_color_manual(values = custom_colors) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    title = "Proportion of Pneumococcal Infecton \nSerotype Groups by Year in Nepal",
    y = "Proportion of Cases",
    x = "Year",
    color = "Serotype Group"
  ) +
  theme_linedraw() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    strip.text = element_text(size = 12),
    axis.title = element_text(size = 11)
  )
```
