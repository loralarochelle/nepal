---
title: "EDAPlot"
output: pdf_document
date: "2025-07-16"
---

Pre and post vaccine percentages of vaccine targeted graphs ordered by percentage
change by serotype, only pcv10, do proportion of serotype out of total cases,
but 

```{r}
library(ggplot2)
library(dplyr)
library(tidyr)
```


```{r}
# Loading in the datasets
nepalGps = read.csv("nepal_gps.csv")
nepalNonGps = read.csv("nepal.csv")
```

```{r}
# Selecting only the columns we need from the gps data
GpsShortened <- nepalGps[, c("Year", "Clinical_manifestation", "In_silico_serotype", "Vaccine_period")]
```

```{r}
# Adding a column of whether or not the serotype was targeted in the PCV10 vaccine
pcv10Serotypes1 <- c('1', '4', '5', '6B', '7F', '9V', '14', '18C', '19F', '23F')

GpsShortened$PCV10_group <- ifelse(GpsShortened$In_silico_serotype %in% pcv10Serotypes1,"PCV10", "Non-PCV10")
```

```{r}
# Selecting only carriage cases and cleaning
pcv10GpsCarriage <- GpsShortened %>%
  filter(Clinical_manifestation == "CARRIAGE") %>%
  filter(!(In_silico_serotype %in% c("COVERAGE TOO LOW", "UNTYPABLE", "SWISS_NT", "ALTERNATIVE_ALIB_NT"))) %>%
    mutate(vPeriod = case_when(
    Vaccine_period == "POSTPCV10-2YR" ~ "POSTPCV",
    Vaccine_period == "POSTPCV10-3YR" ~ "POSTPCV",
    TRUE ~ Vaccine_period 
  ))
```

```{r}
# Grouping by year and serotype
#readyAlmost <- pcv10GpsCarriage %>%
#  dplyr::select(Year, In_silico_serotype, PCV10_group, vPeriod) %>%
#  group_by(Year, In_silico_serotype) %>%
#  dplyr::summarize(IPDCount = n(), .groups = "drop")

readyAlmostGps <- pcv10GpsCarriage %>%
  dplyr::select(Year, In_silico_serotype, PCV10_group, vPeriod) %>%
  group_by(Year, In_silico_serotype) %>%
  dplyr::summarize(
    IPDCount = n(),
    PCV10_group = first(PCV10_group),     
    vPeriod = first(vPeriod),            
    .groups = "drop")
```


Starting with non gps data here

```{r}
# Pivoting the non gps dataset
pcv10NonGpsCarriage <- nepalNonGps %>%
  # Selecting year columns
  dplyr::select(Serotype, X2014n, X2015n, X2017n, X2018n, X2019n, X2021n) %>%
  # Formating data frame
  pivot_longer(cols = starts_with('X'),
               names_to = "Year",
               values_to = "Count") %>%
  # Removing X and n from the year counts
  mutate(Year = gsub("X|n", "", Year)) %>%
  group_by(Serotype)
```

```{r}
# Adding a column of whether or not it is pre or post pcv
pcv10NonGpsCarriage2 <- pcv10NonGpsCarriage %>%
  mutate(vPeriod = case_when(
    Year == "2014" ~ "PREPCV",
    Year == "2015" ~ "PREPCV",
    Year == "2017" ~ "POSTPCV",
    Year == "2018" ~ "POSTPCV",
    Year == "2019" ~ "POSTPCV",
    Year == "2021" ~ "POSTPCV"))
```

```{r}
nonGpsCleaned <- pcv10NonGpsCarriage2 %>% 
  filter(!(Serotype == "PCV10serotypes" | Serotype == "Total"))
```

```{r}
# Adding a column that is whether or not the serotype is targeted by PCV10 or not
nonGpsCleaned2 <- nonGpsCleaned %>%
  mutate(PCV10_group = case_when(
    Serotype == "1" ~ "PCV10",
    Serotype == "4" ~ "PCV10",
    Serotype == "5" ~ "PCV10",
    Serotype == "6B" ~ "PCV10",
    Serotype == "7F" ~ "PCV10",
    Serotype == "9V" ~ "PCV10",
    Serotype == "14" ~ "PCV10",
    Serotype == "18C" ~ "PCV10",
    Serotype == "19F" ~ "PCV10",
    Serotype == "23F" ~ "PCV10",
    Serotype == "3" ~ "Non-PCV10",
    Serotype == "6A" ~ "Non-PCV10",
    Serotype == "19A" ~ "Non-PCV10",
    Serotype == "22F" ~ "Non-PCV10",
    Serotype == "33F" ~ "Non-PCV10",
    Serotype == "8" ~ "Non-PCV10",
    Serotype == "10A" ~ "Non-PCV10",
    Serotype == "11A" ~ "Non-PCV10",
    Serotype == "12F" ~ "Non-PCV10",
    Serotype == "15B" ~ "Non-PCV10",
    Serotype == "Other" ~ "Non-PCV10"))
```

```{r}
# Renaming the serotype column for easy merging
names(readyAlmostGps)[names(readyAlmostGps) == "In_silico_serotype"] <- "Serotype"
```


```{r}
# Merging the gps and nongps data together
mergedDf <- merge(readyAlmostGps, nonGpsCleaned2, by = c("Year", "Serotype", "vPeriod", "PCV10_group"), all = TRUE)
```

```{r}
# Summing the counts from each dataset and filtering for only PCV10 serotypes for plotting purposes
mergedWithSum <- mergedDf %>%
  mutate(CCount = rowSums(across(c(IPDCount, Count)), na.rm = TRUE)) %>%
  dplyr::select(Year, Serotype, vPeriod, PCV10_group, CCount) %>%
  filter(PCV10_group == "PCV10")
```

```{r}
# Calculating the proportion of cases from PCV10 serotypes out of all carriage cases
#serotypeProps <- mergedWithSum %>%
#  group_by(Vaccine_period, PCV10_group, In_silico_serotype) %>%  
#  summarise(n = n()) %>%  
#  mutate(proportion = n / sum(n))

# Step 1: Compute counts by vPeriod and Serotype
serotypeProps <- mergedWithSum %>%
  group_by(vPeriod, Serotype) %>%
  summarise(count = sum(CCount, na.rm = TRUE), .groups = "drop")

# Step 2: Compute proportions out of the grand total (not within vPeriod)
total_count_all <- sum(serotypeProps$count, na.rm = TRUE)

serotypeProps <- serotypeProps %>%
  mutate(proportion = count / total_count_all) %>%
  arrange(vPeriod)

```


```{r}
#serotypeProps <- serotypeProps %>%
#  mutate(vPeriod = factor(vPeriod, levels = c("PREPCV", "POSTPCV")))


ggplot(serotypeProps, aes(x = Serotype, y = proportion, fill = vPeriod)) +
  geom_col(position = position_dodge(width = 0.8)) +
  scale_fill_manual(name = "Vaccine Period", values = c("PREPCV" = "darkgreen", "POSTPCV" = "darkred")) +
  labs(x = "Serotype", y = "Proportion") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```



```{r}
# Creating a bar chart of pre vs post vaccine percentages of PCV10 serotypes ordered by percentage change by serotype
ggplot(serotypeProps, aes(x = Serotype, y = proportion)) +
  # Post period in background
  geom_col(data = subset(serotypeProps, vPeriod == "POSTPCV"),
           aes(fill = "POSTPCV"), 
           position = "identity") +
  # Pre period in foreground
  geom_col(data = subset(serotypeProps, vPeriod == "PREPCV"),
           aes(fill = "PREPCV"), 
           position = "identity", alpha = .8) +
  scale_fill_manual(name = "vPeriod", values = c("PREPCV" = "darkgreen", "POSTPCV" = "red")) +
  labs(x = "Serotype", y = "Proportion") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
library(ggplot2)

ggplot(serotypeProps, aes(x = Serotype, y = proportion, fill = vPeriod)) +
  geom_col(position = "dodge") +
  labs(x = "Serotype", y = "Proportion", fill = "Vaccine Period") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```

```{r}
# Getting the counts by serotype and period
preCounts <- serotypeProps %>%
  filter(vPeriod == "PREPCV") %>%
  dplyr::select(Serotype, preProp = proportion)

postCounts <- serotypeProps %>%
  filter(vPeriod == "POSTPCV") %>%
  dplyr::select(Serotype, postProp = proportion)
```

```{r}
# Calculating the difference in proportions from pre to post pcv period
changeTable <- left_join(preCounts, postCounts, by = "Serotype") %>%
  mutate(diffProp = postProp - preProp) %>%
  arrange(desc(diffProp)) %>%
  mutate(Serotype = factor(Serotype, levels = Serotype))
```

```{r}
# Factoring the serotype to make pre come before post
serotypeProps <- serotypeProps %>%
  mutate(Serotype = factor(Serotype, levels = levels(changeTable$Serotype)))
```


```{r}
# Factoring so pre comes before post
serotypeProps$vPeriod <- factor(serotypeProps$vPeriod, levels = c("PREPCV", "POSTPCV"))

# Plotting
barProps <- 
ggplot(serotypeProps, aes(x = Serotype, y = proportion, fill = vPeriod)) +
  geom_col(position = position_dodge(width = 0.8)) +
  labs(title = "Proportions of Pneumococcal Serotypes by Vaccine Period",
       subtitle = "Ordered by Change in Proportion",
       x = "Serotype", y = "Proportion") +
  theme_minimal() +
  scale_fill_manual(
  name = "Vaccine Period",
  values = c("PREPCV" = "#33a1a1", "POSTPCV" = "#00356B"),
  labels = c("PREPCV" = "Pre-PCV", "POSTPCV" = "Post-PCV")
) +
  theme(panel.spacing = unit(2, 'lines'),
        axis.text.x = element_text(angle = 45, size = 12),
            axis.text.y = element_text(size = 12),
            axis.title = element_text(size = 12),
            axis.title.x = element_text(size = 14),
            axis.title.y =element_text(size = 14),
            plot.title = element_text(size = 18, face = "bold"),
            plot.subtitle = element_text(size = 14))
barProps
ggsave(filename="barChartProps.jpeg", plot = barProps, width=8, height=7)
```

Trying something

```{r}
# Using the same merge from above just without filtering for only PCV10 serotypes
mergedEVERYTHING <- mergedDf %>%
  mutate(CCount = rowSums(across(c(IPDCount, Count)), na.rm = TRUE)) %>%
  dplyr::select(Year, Serotype, vPeriod, PCV10_group, CCount)
```


```{r}
# Defining other PCV groups
pcv10_serotypes <- c("1", "4", "5", "6B", "7F", "9V", "14", "18C", "19F", "23F")
pcv13_only      <- c("3", "6A", "19A")
pcv15_only      <- c("22F", "33F")
pcv20_only      <- c("8", "10A", "11A", "12F")
```

```{r}
# Making a new variable that is more specific vaccine group
mergedEVERYTHING <- mergedEVERYTHING %>%
  mutate(vaccineGroup = case_when(
    Serotype %in% pcv10_serotypes ~ "PCV10",
    Serotype %in% pcv13_only ~ "Only PCV13",
    Serotype %in% pcv15_only ~ "Only PCV15",
    Serotype %in% pcv20_only ~ "Only PCV20",
    TRUE ~ "Other"
  ))

```

```{r}
# Finding the counts of each case by vaccine group and period
groupProps <- mergedEVERYTHING %>%
  group_by(vPeriod, vaccineGroup) %>%
  summarise(count = sum(CCount, na.rm = TRUE), .groups = "drop")
```

```{r}
# Calculating the proportion
groupProps <- groupProps %>%
  group_by(vPeriod) %>%
  mutate(proportion = count / sum(count)) %>%
  ungroup()
```


```{r}
# Plotting
ggplot(groupProps, aes(x = vaccineGroup, y = proportion, fill = vPeriod)) +
  geom_col(position = position_dodge(width = 0.8)) +
  scale_fill_manual(
    name = "Vaccine Period",
    values = c("PREPCV" = "#008080", "POSTPCV" = "#00356B"),
    labels = c("PREPCV" = "Pre-PCV", "POSTPCV" = "Post-PCV")) +
  labs(
    x = "Vaccine Serotype Group",
    y = "Proportion",
    title = "Serotype Group Proportions Pre and Post PCV-10 Implementation") +
  theme_minimal()
```


